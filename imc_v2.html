import os
import json
import snowflake.connector
from datetime import datetime, timedelta

def get_connection():
    return snowflake.connector.connect(
        user=os.environ['SF_USER'],
        password=os.environ['SF_PASSWORD'],
        account="gv28284.ap-northeast-2.aws",
        warehouse="DEV_WH",
        database="FNF",
        schema="CRM_MEMBER"
    )

def fetch_and_process():
    print("ğŸš€ Starting Data Sync Process...")
    conn = get_connection()
    cursor = conn.cursor()

    try:
        # ---------------------------------------------------------
        # 1. ê¸°íšì „ ê³„íš(Plan) ê°€ì ¸ì˜¤ê¸°
        # ---------------------------------------------------------
        print("1. Fetching Promotion Plan...")
        cursor.execute("SELECT * FROM PROMOTION_PLAN")
        cols = [col[0] for col in cursor.description]
        plans = [dict(zip(cols, row)) for row in cursor.fetchall()]

        # ---------------------------------------------------------
        # 2. ì‹¤ì  ë°ì´í„°(Actual) ê°€ì ¸ì˜¤ê¸°
        # ---------------------------------------------------------
        print("2. Fetching Daily Sales Data...")
        # ë‚ ì§œë¥¼ ë¬¸ìì—´ë¡œ ê°€ì ¸ì˜¤ë©´ ë§¤í•‘ì´ í¸í•©ë‹ˆë‹¤.
        cursor.execute("""
            SELECT TO_VARCHAR(SALE_DATE, 'YYYY-MM-DD') as SD, BRAND, CHANNEL, REVENUE 
            FROM DAILY_CHANNEL_SALES
        """)
        sales_data = cursor.fetchall()

        # ---------------------------------------------------------
        # 3. ê³ ì† ì¡°íšŒë¥¼ ìœ„í•œ ë§¤í•‘ í…Œì´ë¸” ìƒì„± (Memory Mapping)
        # Key: (ë¸Œëœë“œ, ì±„ë„, ë‚ ì§œ) -> Value: ë§¤ì¶œì•¡
        # ---------------------------------------------------------
        print("3. Building Sales Map...")
        sales_map = {}
        for row in sales_data:
            date_str, brand, channel, revenue = row
            key = (brand, channel, date_str)
            # í˜¹ì‹œ ë°ì´í„°ê°€ ì¤‘ë³µë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í•©ì‚° (`+=`)
            sales_map[key] = sales_map.get(key, 0) + int(revenue)

        # ---------------------------------------------------------
        # 4. ê¸°íšì „ë³„ ì‹¤ì  ê³„ì‚° (Mapping)
        # ---------------------------------------------------------
        print("4. Calculating Promotion Performance...")
        final_data = []
        
        for p in plans:
            # ë‚ ì§œ í˜•ì‹ì´ ë¬¸ìì—´ì¸ì§€ ê°ì²´ì¸ì§€ í™•ì¸ í›„ í†µì¼
            start_str = str(p['START_DATE'])
            end_str = str(p['END_DATE'])
            
            try:
                s_date = datetime.strptime(start_str, '%Y-%m-%d')
                e_date = datetime.strptime(end_str, '%Y-%m-%d')
            except ValueError:
                # ë‚ ì§œ í˜•ì‹ì´ ì˜ëª»ëœ ê²½ìš° ì‹¤ì  0 ì²˜ë¦¬í•˜ê³  ë„˜ê¹€
                print(f"   [Skip] Invalid Date: {p.get('PROMO_NAME', 'Unknown')}")
                p['ACTUAL_SALES'] = 0
                p['DAILY_TREND'] = []
                final_data.append(p)
                continue

            total_revenue = 0
            daily_trend = []
            
            # ì‹œì‘ì¼ ~ ì¢…ë£Œì¼ ë£¨í”„ ëŒë©´ì„œ ë§¤ì¶œ í•©ì‚°
            curr = s_date
            while curr <= e_date:
                curr_str = curr.strftime('%Y-%m-%d')
                
                # ë¸Œëœë“œ+ì±„ë„+ë‚ ì§œê°€ ì¼ì¹˜í•˜ëŠ” ë§¤ì¶œ ì°¾ê¸°
                # (ì£¼ì˜: ëŒ€ì‹œë³´ë“œ ì±„ë„ëª…ê³¼ DB ì±„ë„ëª…ì´ ì •í™•íˆ ê°™ì•„ì•¼ í•¨)
                rev = sales_map.get((p['BRAND'], p['CHANNEL'], curr_str), 0)
                
                total_revenue += rev
                daily_trend.append(rev) # ì¼ë³„ ì¶”ì´ ê·¸ë˜í”„ìš© ë°ì´í„°
                
                curr += timedelta(days=1)

            # ê³„ì‚°ëœ ì‹¤ì ì„ JSON ë°ì´í„°ì— ì¶”ê°€
            p['ACTUAL_SALES'] = total_revenue
            p['DAILY_TREND'] = daily_trend
            
            final_data.append(p)

        # ---------------------------------------------------------
        # 5. ê²°ê³¼ ì €ì¥
        # ---------------------------------------------------------
        with open('data.json', 'w', encoding='utf-8') as f:
            json.dump(final_data, f, ensure_ascii=False, indent=4)
            
        print(f"âœ… Success! Processed {len(final_data)} promotions.")

    except Exception as e:
        print(f"âŒ Error: {e}")
        raise e
    finally:
        cursor.close()
        conn.close()

if __name__ == "__main__":
    fetch_and_process()
